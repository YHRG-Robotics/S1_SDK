import time
import argparse
from S1_SDK import S1_arm, control_mode

"""
本代码为测试机械臂自碰撞检测功能。
机械臂不使能运动控制（仅重力补偿），调用 joint_control 接口，
此时机械臂不会主动运动，可以手动拖动。
当机械臂与自身发生碰撞时，终端会打印警告信息。
"""

# 映射字符串到 control_mode 枚举
MODE_MAP = {
    "only_real": control_mode.only_real,
    "only_sim": control_mode.only_sim,
}

def main():
    parser = argparse.ArgumentParser(description="S1 机械臂自碰撞检测测试脚本")
    parser.add_argument("--dev", type=str, default="COM23", help="串口设备，例如 COM23 或 /dev/ttyUSB0")
    parser.add_argument("--end", type=str, default="None", help="末端执行器类型，例如 'gripper', 'None' 等")

    args = parser.parse_args()

    # 创建机械臂实例
    arm = S1_arm(
        mode=control_mode.real_control_sim,
        dev=args.dev,
        end_effector=args.end
    )

    try:
        arm.enable()
        print(f"机械臂已使能，设备: {args.dev}, 模式: {args.mode}, 末端: {args.end}")
        current_pos = [0.0] * 6

        while True:
            arm.refresh()
            arm.gravity()  # 启用重力补偿（可拖动）
            current_pos = arm.get_pos()
            arm.joint_control(current_pos)  # 发送当前位置，防止运动
            time.sleep(0.001)

    except KeyboardInterrupt:
        print("\n检测到 Ctrl+C，机械臂失能中...")
    finally:
        arm.close()
        print("机械臂已失能，安全退出。")

if __name__ == "__main__":
    main()